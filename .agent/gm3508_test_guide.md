# GM3508 å‡é€Ÿæ¯”å’Œè§’åº¦è¿‡é›¶æµ‹è¯•æŒ‡å—

## âœ… å·²å®žçŽ°çš„åŠŸèƒ½

### 1. 19:1 å‡é€Ÿæ¯”å¤„ç†
**é…ç½®**ï¼ˆ`dji_motor.cpp:12-13`ï¼‰ï¼š
```cpp
(type == MotorType::DJI_GM3508) ? 19.0f : 1.0f,  // å‡é€Ÿæ¯”
(type == MotorType::DJI_GM6020)  // GM6020 ç¼–ç å™¨åœ¨è¾“å‡ºè½´ï¼ŒGM3508 ç¼–ç å™¨åœ¨ç”µæœºè½´
```

**è½¬æ¢é€»è¾‘**ï¼ˆ`motor_base.hpp:143-149`ï¼‰ï¼š
- ç¼–ç å™¨è¯»æ•°ï¼šç”µæœºè½´ä½ç½®ï¼ˆ0-8191ï¼‰
- è¾“å‡ºè½´ä½ç½® = ç”µæœºè½´ä½ç½® / 19.0
- **ç”µæœºè½´è½¬ 19 åœˆ = è¾“å‡ºè½´è½¬ 1 åœˆ**

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# æŸ¥çœ‹ç”µæœºçŠ¶æ€
ros2 topic echo /dji_motor_states | grep -A 10 "DJI3508_2"

# è¾“å‡ºç¤ºä¾‹ï¼š
# angle: 45.0  â† è¾“å‡ºè½´è§’åº¦ï¼ˆåº¦ï¼‰
# 
# å¯¹åº”å…³ç³»ï¼š
# - è¾“å‡ºè½´ 45Â° = ç”µæœºè½´ 855Â° (45 Ã— 19)
# - è¾“å‡ºè½´ 360Â° = ç”µæœºè½´ 6840Â° (19 åœˆ)
```

### 2. è§’åº¦è¿‡é›¶é—®é¢˜ï¼ˆæœ€çŸ­è·¯å¾„ï¼‰
**å®žçŽ°ä½ç½®**ï¼ˆ`cascade_controller.hpp:100-110`ï¼‰ï¼š
```cpp
// å¤„ç†è§’åº¦è¿‡é›¶é—®é¢˜ï¼šé€‰æ‹©æœ€çŸ­è·¯å¾„
double angle_error = position_target - position_feedback;

// å½’ä¸€åŒ–åˆ° [-180, 180] åº¦ï¼Œé€‰æ‹©æœ€çŸ­è·¯å¾„
while (angle_error > 180.0) angle_error -= 360.0;
while (angle_error < -180.0) angle_error += 360.0;

// ä½¿ç”¨å½’ä¸€åŒ–åŽçš„ç›®æ ‡è¿›è¡Œ PID è®¡ç®—
double normalized_target = position_feedback + angle_error;
```

**å·¥ä½œåŽŸç†**ï¼š
| å½“å‰ä½ç½® | ç›®æ ‡ä½ç½® | åŽŸå§‹è¯¯å·® | å½’ä¸€åŒ–è¯¯å·® | æ—‹è½¬æ–¹å‘ |
|---------|---------|---------|-----------|---------|
| 10Â°     | 350Â°    | +340Â°   | **-20Â°**  | é€†æ—¶é’ˆï¼ˆæœ€çŸ­ï¼‰ |
| 350Â°    | 10Â°     | -340Â°   | **+20Â°**  | é¡ºæ—¶é’ˆï¼ˆæœ€çŸ­ï¼‰ |
| 0Â°      | 180Â°    | +180Â°   | +180Â°     | ä»»æ„æ–¹å‘ |
| 90Â°     | 270Â°    | +180Â°   | +180Â°     | ä»»æ„æ–¹å‘ |

## ðŸ§ª æµ‹è¯•æ­¥éª¤

### æµ‹è¯• 1: å‡é€Ÿæ¯”éªŒè¯

#### 1.1 æ‰‹åŠ¨æ—‹è½¬æµ‹è¯•
```bash
# å¯åŠ¨ç›‘æŽ§èŠ‚ç‚¹
ros2 run motor_control_ros2 motor_monitor_node

# æ‰‹åŠ¨æ—‹è½¬ GM3508 è¾“å‡ºè½´ 1 åœˆï¼ˆ360Â°ï¼‰
# è§‚å¯Ÿç›‘æŽ§ç•Œé¢çš„è§’åº¦å˜åŒ–ï¼šåº”è¯¥ä»Ž 0Â° â†’ 360Â° â†’ 0Â°

# åŒæ—¶ï¼Œç”µæœºè½´åº”è¯¥è½¬äº† 19 åœˆ
```

#### 1.2 ç¼–ç å™¨è®¡æ•°éªŒè¯
```bash
# æŸ¥çœ‹åŽŸå§‹ç¼–ç å™¨å€¼ï¼ˆéœ€è¦æ·»åŠ è°ƒè¯•è¾“å‡ºï¼‰
# è¾“å‡ºè½´ 1 åœˆ = ç”µæœºè½´ 19 åœˆ = ç¼–ç å™¨ 155,648 ä¸ªè®¡æ•° (19 Ã— 8192)
```

### æµ‹è¯• 2: è§’åº¦è¿‡é›¶ï¼ˆæœ€çŸ­è·¯å¾„ï¼‰

#### 2.1 ä»Ž 10Â° åˆ° 350Â°ï¼ˆåº”è¯¥é€†æ—¶é’ˆ -20Â°ï¼‰
```bash
# å‘é€ä½ç½®å‘½ä»¤ï¼šä»Ž 10Â° åˆ° 350Â°
ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 10.0}'

# ç­‰å¾…ç”µæœºåˆ°è¾¾ 10Â°

ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 350.0}'

# è§‚å¯Ÿï¼šç”µæœºåº”è¯¥é€†æ—¶é’ˆæ—‹è½¬çº¦ 20Â°ï¼ˆæœ€çŸ­è·¯å¾„ï¼‰
# è€Œä¸æ˜¯é¡ºæ—¶é’ˆæ—‹è½¬ 340Â°
```

#### 2.2 ä»Ž 350Â° åˆ° 10Â°ï¼ˆåº”è¯¥é¡ºæ—¶é’ˆ +20Â°ï¼‰
```bash
# å‘é€ä½ç½®å‘½ä»¤ï¼šä»Ž 350Â° åˆ° 10Â°
ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 350.0}'

# ç­‰å¾…ç”µæœºåˆ°è¾¾ 350Â°

ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 10.0}'

# è§‚å¯Ÿï¼šç”µæœºåº”è¯¥é¡ºæ—¶é’ˆæ—‹è½¬çº¦ 20Â°ï¼ˆæœ€çŸ­è·¯å¾„ï¼‰
# è€Œä¸æ˜¯é€†æ—¶é’ˆæ—‹è½¬ 340Â°
```

#### 2.3 è·¨è¶Š 0Â° ç‚¹æµ‹è¯•
```bash
# æµ‹è¯•åºåˆ—ï¼š0Â° â†’ 180Â° â†’ 0Â° â†’ 350Â° â†’ 10Â° â†’ 0Â°

# 1. åˆ° 0Â°
ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 0.0}'

sleep 3

# 2. åˆ° 180Â°ï¼ˆé¡ºæ—¶é’ˆ 180Â°ï¼‰
ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 180.0}'

sleep 3

# 3. å›žåˆ° 0Â°ï¼ˆé€†æ—¶é’ˆ 180Â°ï¼‰
ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 0.0}'

sleep 3

# 4. åˆ° 350Â°ï¼ˆé€†æ—¶é’ˆ 10Â°ï¼Œæœ€çŸ­è·¯å¾„ï¼‰
ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 350.0}'

sleep 3

# 5. åˆ° 10Â°ï¼ˆé¡ºæ—¶é’ˆ 20Â°ï¼Œæœ€çŸ­è·¯å¾„ï¼‰
ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 10.0}'

sleep 3

# 6. å›žåˆ° 0Â°ï¼ˆé€†æ—¶é’ˆ 10Â°ï¼‰
ros2 topic pub --once /dji_motor_command_advanced motor_control_ros2/msg/DJIMotorCommandAdvanced \
  '{joint_name: "DJI3508_2", mode: 2, position_target: 0.0}'
```

### æµ‹è¯• 3: PID å‚æ•°è°ƒè¯•

#### 3.1 æŸ¥çœ‹å½“å‰ PID å‚æ•°
```bash
# æŸ¥çœ‹é…ç½®æ–‡ä»¶
cat src/motor_control_ros2/config/pid_params.yaml | grep -A 15 "GM3508"

# è¾“å‡ºï¼š
# GM3508:
#   position_pid:
#     kp: 10.0
#     ki: 0.5
#     kd: 0.0
#     i_max: 10.0
#     out_max: 300.0    # æœ€å¤§é€Ÿåº¦ç›®æ ‡ï¼ˆRPMï¼‰
#     dead_zone: 0.5    # ä½ç½®æ­»åŒºï¼ˆåº¦ï¼‰
#   
#   velocity_pid:
#     kp: 20.0
#     ki: 0.5
#     kd: 0.0
#     i_max: 500.0
#     out_max: 16384.0  # æœ€å¤§ç”µæµ
#     dead_zone: 5.0    # é€Ÿåº¦æ­»åŒºï¼ˆRPMï¼‰
```

#### 3.2 è°ƒæ•´ PID å‚æ•°
å¦‚æžœä½ç½®æŽ§åˆ¶æœ‰éœ‡è¡æˆ–å“åº”æ…¢ï¼Œå¯ä»¥è°ƒæ•´å‚æ•°ï¼š

**ä½ç½®çŽ¯è°ƒè¯•**ï¼š
1. å¢žåŠ  `kp`ï¼šæé«˜å“åº”é€Ÿåº¦ï¼ˆä½†å¯èƒ½éœ‡è¡ï¼‰
2. å¢žåŠ  `kd`ï¼šå‡å°‘è¶…è°ƒå’Œéœ‡è¡
3. å¢žåŠ  `ki`ï¼šæ¶ˆé™¤ç¨³æ€è¯¯å·®ï¼ˆå°å¿ƒç§¯åˆ†é¥±å’Œï¼‰

**é€Ÿåº¦çŽ¯è°ƒè¯•**ï¼š
1. å¢žåŠ  `kp`ï¼šæé«˜é€Ÿåº¦è·Ÿè¸ªç²¾åº¦
2. å¢žåŠ  `ki`ï¼šæ¶ˆé™¤é€Ÿåº¦ç¨³æ€è¯¯å·®
3. å¢žåŠ  `kd`ï¼šæŠ‘åˆ¶é«˜é¢‘éœ‡è¡

## ðŸ“Š é¢„æœŸç»“æžœ

### âœ… å‡é€Ÿæ¯”æ­£ç¡®çš„è¡¨çŽ°
- è¾“å‡ºè½´è½¬ 1 åœˆï¼Œç›‘æŽ§æ˜¾ç¤ºè§’åº¦ä»Ž 0Â° â†’ 360Â°
- ç”µæœºè½´å®žé™…è½¬äº† 19 åœˆ
- é€Ÿåº¦æ˜¾ç¤ºä¸ºè¾“å‡ºè½´é€Ÿåº¦ï¼ˆç”µæœºè½´é€Ÿåº¦ / 19ï¼‰

### âœ… è§’åº¦è¿‡é›¶æ­£ç¡®çš„è¡¨çŽ°
- ä»Ž 10Â° åˆ° 350Â°ï¼šé€†æ—¶é’ˆæ—‹è½¬çº¦ 20Â°ï¼ˆä¸æ˜¯é¡ºæ—¶é’ˆ 340Â°ï¼‰
- ä»Ž 350Â° åˆ° 10Â°ï¼šé¡ºæ—¶é’ˆæ—‹è½¬çº¦ 20Â°ï¼ˆä¸æ˜¯é€†æ—¶é’ˆ 340Â°ï¼‰
- ä»Ž 0Â° åˆ° 359Â°ï¼šé¡ºæ—¶é’ˆæ—‹è½¬ 1Â°ï¼ˆä¸æ˜¯é€†æ—¶é’ˆ 359Â°ï¼‰
- ä»Ž 359Â° åˆ° 0Â°ï¼šé¡ºæ—¶é’ˆæ—‹è½¬ 1Â°ï¼ˆä¸æ˜¯é€†æ—¶é’ˆ 359Â°ï¼‰

### âŒ å¦‚æžœå‡ºçŽ°é—®é¢˜

**é—®é¢˜ 1ï¼šè¾“å‡ºè½´è½¬ 1 åœˆï¼Œè§’åº¦æ˜¾ç¤ºè½¬äº† 19 åœˆ**
- **åŽŸå› **ï¼šå‡é€Ÿæ¯”é…ç½®é”™è¯¯æˆ–ç¼–ç å™¨ä½ç½®é…ç½®é”™è¯¯
- **æ£€æŸ¥**ï¼šç¡®è®¤ `encoder_on_output_ = false` å’Œ `gear_ratio_ = 19.0`

**é—®é¢˜ 2ï¼šä»Ž 10Â° åˆ° 350Â° é¡ºæ—¶é’ˆæ—‹è½¬äº† 340Â°**
- **åŽŸå› **ï¼šè§’åº¦è¿‡é›¶é€»è¾‘æœªç”Ÿæ•ˆ
- **æ£€æŸ¥**ï¼šç¡®è®¤ä½¿ç”¨äº† `DJIMotorCommandAdvanced` æ¶ˆæ¯ï¼Œ`mode = 2`ï¼ˆä½ç½®æ¨¡å¼ï¼‰

**é—®é¢˜ 3ï¼šç”µæœºéœ‡è¡æˆ–ä¸ç¨³å®š**
- **åŽŸå› **ï¼šPID å‚æ•°ä¸åˆé€‚
- **è§£å†³**ï¼šé™ä½Ž `kp`ï¼Œå¢žåŠ  `kd`ï¼Œæ£€æŸ¥ `out_max` é™å¹…

## ðŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹å®žæ—¶è§’åº¦
```bash
# æŒç»­ç›‘æŽ§è§’åº¦å˜åŒ–
watch -n 0.1 "ros2 topic echo /dji_motor_states --once | grep -A 3 'DJI3508_2' | grep angle"
```

### æŸ¥çœ‹ PID è¯¯å·®ï¼ˆéœ€è¦æ·»åŠ è°ƒè¯•è¾“å‡ºï¼‰
å¯ä»¥åœ¨ `cascade_controller.hpp` ä¸­æ·»åŠ è°ƒè¯•è¾“å‡ºï¼š
```cpp
// åœ¨ update() å‡½æ•°ä¸­æ·»åŠ 
RCLCPP_INFO_THROTTLE(..., "Pos Error: %.2fÂ°, Vel Target: %.1f RPM", 
                      angle_error, vel_target_from_pos);
```

### å½•åˆ¶æµ‹è¯•æ•°æ®
```bash
# å½•åˆ¶ç”µæœºçŠ¶æ€
ros2 bag record /dji_motor_states -o gm3508_test

# å›žæ”¾åˆ†æž
ros2 bag play gm3508_test.db3
```

## ðŸ“ æ€»ç»“

**å·²å®Œæˆçš„åŠŸèƒ½**ï¼š
- âœ… 19:1 å‡é€Ÿæ¯”é…ç½®å’Œè½¬æ¢
- âœ… ç¼–ç å™¨ä½ç½®æ­£ç¡®é…ç½®ï¼ˆç”µæœºè½´ï¼‰
- âœ… è§’åº¦è¿‡é›¶æœ€çŸ­è·¯å¾„ç®—æ³•
- âœ… ä½ç½®çŽ¯ + é€Ÿåº¦çŽ¯ä¸²çº§ PID æŽ§åˆ¶

**æµ‹è¯•é‡ç‚¹**ï¼š
1. éªŒè¯å‡é€Ÿæ¯”è½¬æ¢æ˜¯å¦æ­£ç¡®
2. éªŒè¯è§’åº¦è¿‡é›¶æ˜¯å¦é€‰æ‹©æœ€çŸ­è·¯å¾„
3. è°ƒè¯• PID å‚æ•°ä»¥èŽ·å¾—æœ€ä½³æ€§èƒ½

**ä¸‹ä¸€æ­¥**ï¼š
- å®žé™…æµ‹è¯•å¹¶è§‚å¯Ÿç”µæœºè¡Œä¸º
- æ ¹æ®å®žé™…è¡¨çŽ°è°ƒæ•´ PID å‚æ•°
- è®°å½•æµ‹è¯•ç»“æžœå’Œä¼˜åŒ–è¿‡ç¨‹
