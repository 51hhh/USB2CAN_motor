# GM3508 ç´¯ç§¯ç¼–ç å™¨ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°
ç›‘æ§æ˜¾ç¤º GM3508 è§’åº¦æœ€å¤§åªåˆ° 18.8Â°ï¼Œæ— æ³•æ˜¾ç¤ºå®Œæ•´çš„ 0-360Â° èŒƒå›´ã€‚

## æ ¹æœ¬åŸå› 
**GM3508 ç¼–ç å™¨åœ¨ç”µæœºè½´ï¼ˆå‡é€Ÿå‰ï¼‰**ï¼š
- ç¼–ç å™¨å€¼ï¼š0-8191ï¼ˆå•åœˆç»å¯¹å€¼ï¼Œä¸ç´¯ç§¯ï¼‰
- å‡é€Ÿæ¯”ï¼š19:1
- **ç”µæœºè½´è½¬ 19 åœˆ = è¾“å‡ºè½´è½¬ 1 åœˆ**

**åŸæ¥çš„é”™è¯¯é€»è¾‘**ï¼š
```cpp
// é”™è¯¯ï¼šç›´æ¥å°†å•åœˆç¼–ç å™¨å€¼è½¬æ¢ä¸ºä½ç½®
position_ = (raw_angle_ / 8191.0) * 2.0 * M_PI;  // 0-2Ï€ å¼§åº¦

// ç„¶åé™¤ä»¥å‡é€Ÿæ¯”
output_position = position_ / 19.0;  // 0-2Ï€/19 â‰ˆ 0-0.33 å¼§åº¦ â‰ˆ 0-18.9Â°
```

**ç»“æœ**ï¼šè¾“å‡ºè½´ä½ç½®åªèƒ½æ˜¾ç¤º 0-18.9Â°ï¼Œæ— æ³•è¶…è¿‡ï¼

## è§£å†³æ–¹æ¡ˆï¼šç´¯ç§¯ç¼–ç å™¨

### æ ¸å¿ƒæ€æƒ³
è·Ÿè¸ªç¼–ç å™¨çš„**ç´¯ç§¯åœˆæ•°**ï¼Œè®¡ç®—ç”µæœºè½´çš„ç´¯ç§¯ä½ç½®ï¼š

```cpp
// ç´¯ç§¯ä½ç½®ï¼ˆç”µæœºè½´ï¼‰= ç´¯ç§¯åœˆæ•° Ã— 2Ï€ + å½“å‰åœˆå†…ä½ç½®
position_ = encoder_rounds_ * 2.0 * M_PI + (raw_angle_ / 8191.0) * 2.0 * M_PI;

// è¾“å‡ºè½´ä½ç½® = ç”µæœºè½´ä½ç½® / 19
output_position = position_ / 19.0;
```

### è¿‡é›¶æ£€æµ‹
æ£€æµ‹ç¼–ç å™¨ä» 8191 è·³åˆ° 0ï¼ˆæˆ–ä» 0 è·³åˆ° 8191ï¼‰ï¼š

```cpp
int32_t delta = raw_angle_ - last_raw_angle_;

if (delta > 4096) {
    // ä» 8191 è·³åˆ° 0ï¼ˆé€†æ—¶é’ˆè¿‡é›¶ï¼‰
    encoder_rounds_--;
} else if (delta < -4096) {
    // ä» 0 è·³åˆ° 8191ï¼ˆé¡ºæ—¶é’ˆè¿‡é›¶ï¼‰
    encoder_rounds_++;
}
```

### ç¤ºä¾‹è®¡ç®—

| ç”µæœºè½´åœˆæ•° | ç¼–ç å™¨å€¼ | ç”µæœºè½´ä½ç½® | è¾“å‡ºè½´ä½ç½® | ç›‘æ§æ˜¾ç¤º |
|-----------|---------|-----------|-----------|---------|
| 0         | 0       | 0         | 0         | 0Â°      |
| 0         | 4096    | Ï€         | Ï€/19      | 9.5Â°    |
| 0         | 8191    | 2Ï€        | 2Ï€/19     | 18.9Â°   |
| **1**     | 0       | **2Ï€**    | **2Ï€/19** | **18.9Â°** |
| 1         | 4096    | 3Ï€        | 3Ï€/19     | 28.4Â°   |
| ...       | ...     | ...       | ...       | ...     |
| **18**    | 8191    | 38Ï€       | 38Ï€/19    | 341.1Â°  |
| **19**    | 0       | **38Ï€**   | **2Ï€**    | **360Â°** |

**å…³é”®ç‚¹**ï¼š
- ç”µæœºè½´è½¬ 1 åœˆï¼ˆ0-8191ï¼‰â†’ è¾“å‡ºè½´è½¬ 1/19 åœˆï¼ˆ18.9Â°ï¼‰
- ç”µæœºè½´è½¬ 19 åœˆ â†’ è¾“å‡ºè½´è½¬ 1 åœˆï¼ˆ360Â°ï¼‰
- ç´¯ç§¯åœˆæ•°è®©æˆ‘ä»¬èƒ½è·Ÿè¸ªç”µæœºè½´è½¬äº†å¤šå°‘åœˆ

## ä»£ç ä¿®æ”¹

### 1. æ·»åŠ ç´¯ç§¯ç¼–ç å™¨å˜é‡ï¼ˆdji_motor.hppï¼‰
```cpp
// ç´¯ç§¯ç¼–ç å™¨ï¼ˆç”¨äº GM3508ï¼Œç¼–ç å™¨åœ¨ç”µæœºè½´ï¼‰
uint16_t last_raw_angle_;    // ä¸Šä¸€æ¬¡çš„ç¼–ç å™¨å€¼
int32_t encoder_rounds_;     // ç´¯ç§¯åœˆæ•°ï¼ˆç”µæœºè½´ï¼‰
bool first_feedback_;        // æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡åé¦ˆ
```

### 2. åˆå§‹åŒ–å˜é‡ï¼ˆdji_motor.cpp æ„é€ å‡½æ•°ï¼‰
```cpp
, last_raw_angle_(0)
, encoder_rounds_(0)
, first_feedback_(true)
```

### 3. ç´¯ç§¯ç¼–ç å™¨é€»è¾‘ï¼ˆdji_motor.cpp updateFeedbackï¼‰
```cpp
if (!encoder_on_output_) {
    // GM3508: ç¼–ç å™¨åœ¨ç”µæœºè½´ï¼Œéœ€è¦ç´¯ç§¯åœˆæ•°
    if (!first_feedback_) {
        // æ£€æµ‹è¿‡é›¶
        int32_t delta = static_cast<int32_t>(raw_angle_) - static_cast<int32_t>(last_raw_angle_);
        
        if (delta > 4096) {
            encoder_rounds_--;  // é€†æ—¶é’ˆè¿‡é›¶
        } else if (delta < -4096) {
            encoder_rounds_++;  // é¡ºæ—¶é’ˆè¿‡é›¶
        }
    }
    
    last_raw_angle_ = raw_angle_;
    first_feedback_ = false;
    
    // è®¡ç®—ç´¯ç§¯ä½ç½®ï¼ˆç”µæœºè½´ï¼‰
    double rounds_position = encoder_rounds_ * 2.0 * M_PI;
    double current_round_position = (raw_angle_ / 8191.0) * 2.0 * M_PI;
    position_ = rounds_position + current_round_position;
    
} else {
    // GM6020: ç¼–ç å™¨åœ¨è¾“å‡ºè½´ï¼Œç›´æ¥è½¬æ¢
    position_ = (raw_angle_ / 8191.0) * 2.0 * M_PI;
}
```

## æµ‹è¯•éªŒè¯

### é‡æ–°å¯åŠ¨æ§åˆ¶èŠ‚ç‚¹
```bash
# åœæ­¢æ—§çš„æ§åˆ¶èŠ‚ç‚¹
# Ctrl+C

# åŠ è½½æ–°ç¼–è¯‘çš„ä»£ç 
source install/setup.bash

# å¯åŠ¨æ§åˆ¶èŠ‚ç‚¹
ros2 run motor_control_ros2 motor_control_node
```

### æµ‹è¯• 1: æ‰‹åŠ¨æ—‹è½¬
```bash
# æ‰‹åŠ¨é¡ºæ—¶é’ˆæ—‹è½¬ GM3508 è¾“å‡ºè½´ 1 åœˆ
# è§‚å¯Ÿç›‘æ§ç•Œé¢ï¼šè§’åº¦åº”è¯¥ä» 0Â° â†’ 360Â° â†’ 0Â°ï¼ˆå¾ªç¯ï¼‰

# åŒæ—¶è§‚å¯Ÿæ§åˆ¶èŠ‚ç‚¹æ—¥å¿—ï¼š
# [DJI DJI3508_2] Angle=45.0Â° RPM=0 Rounds=2 Temp=20Â°C
#                                          ^^^^^^^^
#                                          ç”µæœºè½´ç´¯ç§¯åœˆæ•°
```

### æµ‹è¯• 2: æŸ¥çœ‹è§’åº¦èŒƒå›´
```bash
# æŸ¥çœ‹ç”µæœºçŠ¶æ€
ros2 topic echo /dji_motor_states | grep -A 10 "DJI3508_2"

# åº”è¯¥çœ‹åˆ°ï¼š
# angle: 45.0   â† è¾“å‡ºè½´è§’åº¦ï¼ˆ0-360Â°ï¼‰
# 
# æ‰‹åŠ¨æ—‹è½¬ç”µæœºï¼Œè§’åº¦åº”è¯¥èƒ½è¾¾åˆ° 360Â°
```

### æµ‹è¯• 3: ç´¯ç§¯åœˆæ•°
```bash
# è§‚å¯Ÿæ§åˆ¶èŠ‚ç‚¹æ—¥å¿—ï¼ˆæ¯ 100 æ¬¡åé¦ˆè¾“å‡ºä¸€æ¬¡ï¼‰
# [DJI DJI3508_2] Angle=0.0Â° RPM=0 Rounds=0 Temp=20Â°C
# 
# é¡ºæ—¶é’ˆæ—‹è½¬è¾“å‡ºè½´ 1 åœˆï¼š
# [DJI DJI3508_2] Angle=360.0Â° RPM=50 Rounds=19 Temp=21Â°C
#                                              ^^
#                                              ç”µæœºè½´è½¬äº† 19 åœˆ
```

## é¢„æœŸç»“æœ

### âœ… ä¿®å¤åçš„è¡¨ç°
- è¾“å‡ºè½´è§’åº¦èŒƒå›´ï¼š**0-360Â°**ï¼ˆå®Œæ•´èŒƒå›´ï¼‰
- ç”µæœºè½´ç´¯ç§¯åœˆæ•°ï¼šéšç€æ—‹è½¬ä¸æ–­å¢åŠ /å‡å°‘
- ç›‘æ§æ˜¾ç¤ºæ­£å¸¸ï¼šå¯ä»¥çœ‹åˆ°å®Œæ•´çš„è§’åº¦å˜åŒ–

### âœ… è°ƒè¯•æ—¥å¿—ç¤ºä¾‹
```
[DJI DJI3508_2] Angle=0.0Â° RPM=0 Rounds=0 Temp=20Â°C
[DJI DJI3508_2] Angle=45.0Â° RPM=100 Rounds=2 Temp=20Â°C
[DJI DJI3508_2] Angle=90.0Â° RPM=100 Rounds=4 Temp=21Â°C
[DJI DJI3508_2] Angle=180.0Â° RPM=100 Rounds=9 Temp=21Â°C
[DJI DJI3508_2] Angle=270.0Â° RPM=100 Rounds=14 Temp=22Â°C
[DJI DJI3508_2] Angle=360.0Â° RPM=100 Rounds=19 Temp=22Â°C
[DJI DJI3508_2] Angle=0.0Â° RPM=0 Rounds=19 Temp=22Â°C  â† å›åˆ° 0Â°ï¼Œåœˆæ•°ä¿æŒ
```

### âœ… ç›‘æ§ç•Œé¢ç¤ºä¾‹
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç§°        â”‚ å‹å·   â”‚ çŠ¶æ€   â”‚ è§’åº¦(Â°) â”‚ æ¸©åº¦ â”‚ é¢‘ç‡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DJI3508_2   â”‚ GM3508 â”‚ åœ¨çº¿   â”‚   245.3 â”‚   22Â°Câ”‚  200Hz â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    ^^^^^^
                                    ç°åœ¨å¯ä»¥æ˜¾ç¤ºå®Œæ•´çš„ 0-360Â° èŒƒå›´ï¼
```

## æŠ€æœ¯ç»†èŠ‚

### GM6020 vs GM3508 å¯¹æ¯”

| ç‰¹æ€§ | GM6020 | GM3508 |
|------|--------|--------|
| ç¼–ç å™¨ä½ç½® | è¾“å‡ºè½´ | ç”µæœºè½´ï¼ˆå‡é€Ÿå‰ï¼‰ |
| å‡é€Ÿæ¯” | 1:1 | 19:1 |
| ç¼–ç å™¨å€¼ | 0-8191 | 0-8191 |
| éœ€è¦ç´¯ç§¯ | âŒ å¦ | âœ… æ˜¯ |
| è¾“å‡ºè½´ 1 åœˆ | ç¼–ç å™¨ 1 åœˆ | ç¼–ç å™¨ 19 åœˆ |
| è§’åº¦èŒƒå›´ | 0-360Â° | 0-360Â° |

### ä¸ºä»€ä¹ˆ GM6020 ä¸éœ€è¦ç´¯ç§¯ï¼Ÿ
GM6020 çš„ç¼–ç å™¨åœ¨**è¾“å‡ºè½´**ä¸Šï¼Œç›´æ¥è¯»å–è¾“å‡ºè½´çš„ç»å¯¹ä½ç½®ï¼ˆ0-360Â°ï¼‰ï¼Œä¸éœ€è¦ç´¯ç§¯ã€‚

### ä¸ºä»€ä¹ˆ GM3508 éœ€è¦ç´¯ç§¯ï¼Ÿ
GM3508 çš„ç¼–ç å™¨åœ¨**ç”µæœºè½´**ä¸Šï¼Œåªèƒ½è¯»å–ç”µæœºè½´çš„å•åœˆä½ç½®ï¼ˆ0-360Â°ï¼‰ã€‚è¦å¾—åˆ°è¾“å‡ºè½´çš„ä½ç½®ï¼Œéœ€è¦ï¼š
1. ç´¯ç§¯ç”µæœºè½´è½¬äº†å¤šå°‘åœˆ
2. é™¤ä»¥å‡é€Ÿæ¯” 19 å¾—åˆ°è¾“å‡ºè½´ä½ç½®

## æ³¨æ„äº‹é¡¹

### 1. ç´¯ç§¯åœˆæ•°ä¼šä¸€ç›´å¢é•¿
ç´¯ç§¯åœˆæ•° `encoder_rounds_` ä¼šéšç€ç”µæœºæ—‹è½¬ä¸æ–­å¢åŠ æˆ–å‡å°‘ï¼Œ**ä¸ä¼šè‡ªåŠ¨æ¸…é›¶**ã€‚

å¦‚æœéœ€è¦æ¸…é›¶ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªæœåŠ¡æˆ–å‘½ä»¤ï¼š
```cpp
void resetEncoder() {
    encoder_rounds_ = 0;
    first_feedback_ = true;
}
```

### 2. æ–­ç”µååœˆæ•°ä¸¢å¤±
ç´¯ç§¯åœˆæ•°å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œ**æ–­ç”µåä¼šä¸¢å¤±**ã€‚é‡æ–°ä¸Šç”µåï¼Œåœˆæ•°ä» 0 å¼€å§‹ã€‚

å¦‚æœéœ€è¦ä¿æŒä½ç½®ï¼Œå¯ä»¥ï¼š
- ä½¿ç”¨ç»å¯¹ç¼–ç å™¨
- å°†ç´¯ç§¯åœˆæ•°ä¿å­˜åˆ°æ–‡ä»¶
- æ·»åŠ é›¶ç‚¹æ ‡å®šåŠŸèƒ½

### 3. è¿‡é›¶æ£€æµ‹é˜ˆå€¼
å½“å‰ä½¿ç”¨ 4096ï¼ˆåŠåœˆï¼‰ä½œä¸ºè¿‡é›¶æ£€æµ‹é˜ˆå€¼ã€‚è¿™æ„å‘³ç€ï¼š
- å¦‚æœç¼–ç å™¨å€¼å˜åŒ– > 4096ï¼Œè®¤ä¸ºæ˜¯é€†æ—¶é’ˆè¿‡é›¶
- å¦‚æœç¼–ç å™¨å€¼å˜åŒ– < -4096ï¼Œè®¤ä¸ºæ˜¯é¡ºæ—¶é’ˆè¿‡é›¶

è¿™ä¸ªé˜ˆå€¼é€‚ç”¨äºæ­£å¸¸çš„è¿ç»­è¿åŠ¨ï¼Œä½†å¦‚æœç”µæœºçªç„¶è·³è·ƒè¶…è¿‡åŠåœˆï¼Œå¯èƒ½ä¼šè¯¯åˆ¤ã€‚

## æ€»ç»“

âœ… **å·²ä¿®å¤**ï¼šGM3508 è§’åº¦æ˜¾ç¤ºèŒƒå›´ä» 0-18.9Â° æ‰©å±•åˆ° 0-360Â°

âœ… **æ ¸å¿ƒæ”¹è¿›**ï¼šæ·»åŠ ç´¯ç§¯ç¼–ç å™¨é€»è¾‘ï¼Œè·Ÿè¸ªç”µæœºè½´çš„ç´¯ç§¯åœˆæ•°

âœ… **å…¼å®¹æ€§**ï¼šGM6020 å’Œ GM3508 ä½¿ç”¨ç»Ÿä¸€çš„æ¥å£ï¼Œè‡ªåŠ¨é€‰æ‹©æ­£ç¡®çš„è½¬æ¢é€»è¾‘

ğŸ¯ **ä¸‹ä¸€æ­¥**ï¼šé‡å¯æ§åˆ¶èŠ‚ç‚¹ï¼Œæµ‹è¯•è§’åº¦æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸
