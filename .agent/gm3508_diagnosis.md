# GM3508 电机诊断指南

## 问题描述
GM3508 电机显示"离线"，没有心跳上下线检测通知。

## 已修复的问题
✅ **编码器位置配置**：已修正 GM3508 编码器在电机轴（减速前），减速比 19:1

## 心跳检测机制说明

### 控制节点 (motor_control_node)
1. **心跳检测**（第 499-507 行）：
   - 每个控制循环都检查所有电机的心跳超时（500ms）
   - 如果 500ms 内未收到反馈 → 设置 `online = false`
   - 收到反馈 → 自动设置 `online = true`

2. **状态发布**（第 510-520 行）：
   - 每次控制循环都发布电机状态
   - 包含 `online` 字段、角度、温度、控制频率

### 监控节点 (motor_monitor_node)
1. **状态变化检测**（第 149-169 行）：
   - 监听所有电机状态消息
   - 检测 `online` 字段的变化
   - **上线**：`online: false → true` → 输出绿色通知 `[INFO] [电机名 上线]`
   - **离线**：`online: true → false` → 输出红色通知 `[WARN] [电机名 离线]`

2. **显示逻辑**（第 171-187 行）：
   - 如果从未收到消息 → 显示"离线"
   - 如果 500ms 未收到消息 → 显示"离线"（控制节点可能停止）
   - 否则显示消息中的 `online` 状态

## GM3508 配置信息

### CAN ID 配置
- **电机 ID**: 2
- **反馈 ID**: `0x202` (0x201 + 1)
- **控制 ID**: `0x200` (ID 1-4 使用此 ID)
- **最大输出**: 16384（电流限幅）

### 编码器配置
- **位置**: 电机轴（减速前）
- **分辨率**: 8192 线/圈
- **减速比**: 19:1
- **输出轴转 1 圈** = 电机轴转 19 圈 = 编码器 155,648 个计数

## 诊断步骤

### 1. 检查 CAN 通信
```bash
# 查看控制节点日志，确认是否收到 GM3508 的反馈
ros2 run motor_control_ros2 motor_control_node

# 应该看到类似的日志（每 100 次反馈输出一次）：
# [DJI DJI3508_2] Angle=xxx.x° RPM=xxx Temp=xx°C
```

### 2. 查看 CAN 发送日志
```bash
# 每秒输出一次 CAN 发送帧
# [CAN TX] can_0 ID: 0x200, Data: 00 00 XX XX 00 00 00 00
#                                      ^^^^^ 
#                                      DJI3508_2 的控制字节（ID=2，偏移2-3）
```

### 3. 查看电机状态话题
```bash
# 查看 DJI3508_2 的状态
ros2 topic echo /dji_motor_states | grep -A 10 "DJI3508_2"

# 应该看到：
# joint_name: DJI3508_2
# model: GM3508
# online: true/false  ← 关键字段
# angle: xxx.x
# temperature: xx
# control_frequency: 200.0
```

### 4. 测试心跳检测
```bash
# 启动监控节点
ros2 run motor_control_ros2 motor_monitor_node

# 如果 GM3508 从未上线过：
# - 不会有任何通知（因为从未触发 false→true 的变化）
# - 监控界面显示"离线"

# 如果 GM3508 已经在线，然后断电：
# - 500ms 后会输出：[WARN] [DJI3508_2 离线]

# 如果 GM3508 重新上电：
# - 收到反馈后会输出：[INFO] [DJI3508_2 上线]
```

## 可能的原因

### GM3508 显示"离线"的原因：
1. **硬件连接问题**：
   - CAN 总线未正确连接
   - 电机未上电
   - CAN 终端电阻未配置

2. **CAN ID 冲突**：
   - 检查是否有其他电机使用相同的 ID

3. **波特率不匹配**：
   - 确认 USB-CAN 适配器波特率为 921600

4. **电机未初始化**：
   - GM3508 可能需要特殊的初始化命令

### 为什么没有"上线"通知：
- **原因**：GM3508 从启动到现在一直是"离线"状态
- **逻辑**：只有当状态从 `false → true` 变化时才会输出"上线"通知
- **解决**：一旦 GM3508 开始正常反馈，就会触发"上线"通知

## 测试命令

### 发送测试命令
```bash
# 发送小电流命令（1000，约 6% 最大电流）
ros2 topic pub --once /dji_motor_command motor_control_ros2/msg/DJIMotorCommand \
  '{joint_name: "DJI3508_2", output: 1000}'

# 如果电机响应，说明通信正常
# 如果没有响应，检查硬件连接
```

### 查看实时反馈
```bash
# 持续查看电机状态（1 秒刷新）
watch -n 1 "ros2 topic echo /dji_motor_states --once | grep -A 10 'DJI3508_2'"
```

## 总结

**心跳检测功能是统一的**，所有电机类型（DJI、达妙、宇树）都有：
- ✅ 500ms 超时检测
- ✅ 上线/离线状态变化通知
- ✅ 实时状态显示

**GM3508 特殊配置**：
- ✅ 编码器在电机轴（已修正）
- ✅ 减速比 19:1（已配置）
- ✅ CAN ID 配置正确

**下一步**：
1. 重新编译并启动控制节点
2. 检查是否收到 GM3508 的 CAN 反馈
3. 一旦收到反馈，监控节点会自动显示"上线"通知
