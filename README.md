# ç”µæœºæ§åˆ¶ç³»ç»Ÿä½¿ç”¨æ‰‹å†Œ

## ğŸ“¦ ç³»ç»Ÿæ¦‚è¿°

ROS2 ç”µæœºæ§åˆ¶ç³»ç»Ÿï¼Œæ”¯æŒå¤šç§ç”µæœºç±»å‹çš„å®æ—¶æ§åˆ¶å’Œç›‘æ§ã€‚

### æ”¯æŒçš„ç”µæœº

| ç”µæœºå‹å· | é€šä¿¡æ¥å£ | æ§åˆ¶æ¨¡å¼ |
|---------|---------|---------|
| DJI GM6020 | CAN | ç”µå‹æ§åˆ¶ |
| DJI GM3508 | CAN | ç”µæµæ§åˆ¶ |
| è¾¾å¦™ DM4340 | CAN | MIT æ¨¡å¼ |
| å®‡æ ‘ GO-8010 | RS485 | åŠ›ä½æ··åˆ |

### ç³»ç»Ÿæ¶æ„

```
åº”ç”¨å±‚: motor_control_node (æ§åˆ¶) + motor_monitor_node (ç›‘æ§)
    â†“
é©±åŠ¨å±‚: DJIMotor, DamiaoMotor, UnitreeMotor
    â†“
ç¡¬ä»¶å±‚: CANInterface, SerialInterface
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘

```bash
cd /home/rick/desktop/ros/usb2can
colcon build --packages-select motor_control_ros2
source install/setup.bash
```

### 2. è¿è¡Œ

**ç»ˆç«¯ 1** - æ§åˆ¶èŠ‚ç‚¹ï¼ˆå¿…é¡»ï¼‰ï¼š
```bash
ros2 run motor_control_ros2 motor_control_node
```

**ç»ˆç«¯ 2** - ç›‘æ§èŠ‚ç‚¹ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰ï¼š
```bash
ros2 run motor_control_ros2 motor_monitor_node
```

## ğŸ“Š ç›‘æ§ç•Œé¢

ç›‘æ§èŠ‚ç‚¹æä¾›å®æ—¶åŠ¨æ€åˆ·æ–°çš„å½©è‰²ç•Œé¢ï¼š

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        ç”µæœºæ§åˆ¶ç³»ç»Ÿå®æ—¶ç›‘æ§                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

è¿è¡Œæ—¶é—´: 123.5s  æ˜¾ç¤ºé¢‘ç‡: 99.8 Hz  ç›®æ ‡: 100 Hz

ã€DJI ç”µæœºã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç§°        â”‚ å‹å·   â”‚ çŠ¶æ€   â”‚ è§’åº¦(Â°) â”‚ æ¸©åº¦ â”‚ é¢‘ç‡   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ yaw_motor   â”‚ GM6020 â”‚ åœ¨çº¿   â”‚   357.0 â”‚  21Â°Câ”‚  100Hz â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æç¤º: æŒ‰ Ctrl+C é€€å‡ºç›‘æ§  |  å¿ƒè·³è¶…æ—¶: 500ms
```

### ç›‘æ§ç‰¹æ€§

- âœ… **100Hz åˆ·æ–°é¢‘ç‡** - æµç•…çš„å®æ—¶æ˜¾ç¤º
- âœ… **å½©è‰²çŠ¶æ€æŒ‡ç¤º** - åœ¨çº¿ğŸŸ¢ / ç¦»çº¿ğŸ”´
- âœ… **å¿ƒè·³æ£€æµ‹** - 500ms è¶…æ—¶è‡ªåŠ¨åˆ¤æ–­
- âœ… **é¢‘ç‡ç»Ÿè®¡** - æ˜¾ç¤ºå®é™…æ¶ˆæ¯é¢‘ç‡
- âœ… **çŠ¶æ€å˜åŒ–é€šçŸ¥** - ä¸Šçº¿/ç¦»çº¿å®æ—¶æé†’

## ğŸ”§ é…ç½®æ–‡ä»¶

### control_params.yaml

```yaml
motor_control_node:
  ros__parameters:
    control_frequency: 500.0     # æ§åˆ¶å¾ªç¯é¢‘ç‡ (Hz)
    publish_frequency: 100.0     # çŠ¶æ€å‘å¸ƒé¢‘ç‡ (Hz)
    config_file: "config/motors.yaml"
```

### motors.yaml

ç”µæœºé…ç½®æ–‡ä»¶ï¼ˆå¾…å®ç° YAML è§£æï¼‰

## ğŸ“¡ ROS2 è¯é¢˜

### å‘å¸ƒçš„è¯é¢˜

- `/dji_motor_states` - DJI ç”µæœºçŠ¶æ€ (100Hz)
- `/damiao_motor_states` - è¾¾å¦™ç”µæœºçŠ¶æ€ (100Hz)
- `/unitree_motor_states` - å®‡æ ‘ A1 ç”µæœºçŠ¶æ€ (100Hz)
- `/unitree_go8010_states` - å®‡æ ‘ GO-8010 ç”µæœºçŠ¶æ€ (100Hz)

### è®¢é˜…çš„è¯é¢˜

- `/dji_motor_command` - DJI ç”µæœºå‘½ä»¤
- `/damiao_motor_command` - è¾¾å¦™ç”µæœºå‘½ä»¤
- `/unitree_motor_command` - å®‡æ ‘ A1 ç”µæœºå‘½ä»¤
- `/unitree_go8010_command` - å®‡æ ‘ GO-8010 ç”µæœºå‘½ä»¤

## ğŸ¯ ç”µæœºçŠ¶æ€åˆ¤æ–­

### åœ¨çº¿/ç¦»çº¿é€»è¾‘

**æ§åˆ¶èŠ‚ç‚¹**ï¼š
- æ”¶åˆ°ç”µæœºåé¦ˆ â†’ è®¾ç½® `online = true`
- 500ms æœªæ”¶åˆ°åé¦ˆ â†’ è®¾ç½® `online = false`
- åœ¨æ¶ˆæ¯ä¸­å‘å¸ƒ `online` çŠ¶æ€

**ç›‘æ§èŠ‚ç‚¹**ï¼š
- æ˜¾ç¤ºæ¶ˆæ¯ä¸­çš„ `online` çŠ¶æ€
- å¦‚æœ 500ms æœªæ”¶åˆ°æ¶ˆæ¯ â†’ æ˜¾ç¤ºç¦»çº¿ï¼ˆæ§åˆ¶èŠ‚ç‚¹å¯èƒ½å·²åœæ­¢ï¼‰

### çŠ¶æ€å˜åŒ–é€šçŸ¥

ç›‘æ§èŠ‚ç‚¹ä¼šåœ¨ç»ˆç«¯è¾“å‡ºçŠ¶æ€å˜åŒ–ï¼š
- **ä¸Šçº¿**: `[INFO] [yaw_motor ä¸Šçº¿]` (ç»¿è‰²)
- **ç¦»çº¿**: `[WARN] [yaw_motor ç¦»çº¿]` (çº¢è‰²)

## ğŸ§ª æµ‹è¯•å‘½ä»¤

### æŸ¥çœ‹è¯é¢˜

```bash
# åˆ—å‡ºæ‰€æœ‰è¯é¢˜
ros2 topic list

# æŸ¥çœ‹ DJI ç”µæœºçŠ¶æ€
ros2 topic echo /dji_motor_states

# æŸ¥çœ‹è¯é¢˜é¢‘ç‡
ros2 topic hz /dji_motor_states
```

### å‘é€æµ‹è¯•å‘½ä»¤

```bash
# DJI ç”µæœºæµ‹è¯• (GM6020 ç”µå‹æ§åˆ¶)
ros2 topic pub --once /dji_motor_command motor_control_ros2/msg/DJIMotorCommand \
  '{joint_name: "yaw_motor", output: 1000}'

# è¾¾å¦™ç”µæœºæµ‹è¯• (MIT æ¨¡å¼)
ros2 topic pub --once /damiao_motor_command motor_control_ros2/msg/DamiaoMotorCommand \
  '{joint_name: "joint1_motor", pos_des: 0.0, vel_des: 0.0, kp: 10.0, kd: 1.0, torque_ff: 0.0}'
```

## âš™ï¸ ç¡¬ä»¶é…ç½®

### CAN æ¥å£

- **è®¾å¤‡**: `/dev/ttyACM0` (USB-CAN é€‚é…å™¨)
- **æ³¢ç‰¹ç‡**: 921600 bps
- **ç”¨é€”**: DJI ç”µæœºã€è¾¾å¦™ç”µæœº

### ä¸²å£æ¥å£

- **è®¾å¤‡**: `/dev/ttyUSB0` (USB-485 é€‚é…å™¨)
- **æ³¢ç‰¹ç‡**: 4000000 bps
- **ç”¨é€”**: å®‡æ ‘ç”µæœº

### æƒé™è®¾ç½®

```bash
# å¦‚æœé‡åˆ°æƒé™é—®é¢˜
sudo chmod 666 /dev/ttyACM0
sudo chmod 666 /dev/ttyUSB0

# æˆ–è€…å°†ç”¨æˆ·æ·»åŠ åˆ° dialout ç»„
sudo usermod -a -G dialout $USER
# ç„¶åé‡æ–°ç™»å½•
```

## ğŸ“ æ·»åŠ æ–°ç”µæœº

å½“å‰ç¤ºä¾‹ç”µæœºå·²æ³¨é‡Šï¼Œéœ€è¦æ ¹æ®å®é™…é…ç½®æ·»åŠ ï¼š

ç¼–è¾‘ `src/motor_control_node.cpp`:

```cpp
void initializeMotors() {
  // æ·»åŠ  CAN æ€»çº¿
  can_network_->addInterface("can0", "/dev/ttyACM0", 921600);
  
  // æ·»åŠ  DJI GM6020 ç”µæœº
  auto dji_motor = std::make_shared<DJIMotor>(
    "yaw_motor", MotorType::DJI_GM6020, 1, 0
  );
  motors_["yaw_motor"] = dji_motor;
  dji_motors_.push_back(dji_motor);
}

void initializeUnitreeMotors() {
  // å–æ¶ˆæ³¨é‡Šå¹¶ä¿®æ”¹å‚æ•°
  std::string port_name = "/dev/ttyUSB0";
  auto port = getSerialPort(port_name);
  
  if (port) {
    auto unitree_motor = std::make_shared<UnitreeMotor>(
      "fl_hip_motor", MotorType::UNITREE_A1, port, 0, 1, 0.0f
    );
    motors_["fl_hip_motor"] = unitree_motor;
    unitree_motors_.push_back(unitree_motor);
  }
}
```

## ğŸ› æ•…éšœæ’æŸ¥

### ç”µæœºæ˜¾ç¤ºç¦»çº¿

1. **æ£€æŸ¥ç¡¬ä»¶è¿æ¥**
   - ç¡®è®¤ USB-CAN/USB-485 å·²è¿æ¥
   - æ£€æŸ¥ç”µæœºä¾›ç”µ

2. **æ£€æŸ¥è®¾å¤‡æƒé™**
   ```bash
   ls -l /dev/ttyACM0 /dev/ttyUSB0
   ```

3. **æŸ¥çœ‹æ—¥å¿—**
   - æ§åˆ¶èŠ‚ç‚¹æ˜¯å¦è¾“å‡º `[DJI xxx] Online!`
   - ç›‘æ§èŠ‚ç‚¹æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯

### ç›‘æ§èŠ‚ç‚¹æ— æ•°æ®

1. **ç¡®è®¤æ§åˆ¶èŠ‚ç‚¹æ­£åœ¨è¿è¡Œ**
   ```bash
   ros2 node list  # åº”è¯¥çœ‹åˆ° motor_control_node
   ```

2. **æ£€æŸ¥è¯é¢˜**
   ```bash
   ros2 topic list
   ros2 topic hz /dji_motor_states
   ```

### é¢‘ç‡ä½äºé¢„æœŸ

1. **æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½**
   ```bash
   top
   ```

2. **æŸ¥çœ‹æ—¥å¿—çº§åˆ«**
   ```bash
   # å‡å°‘æ—¥å¿—è¾“å‡º
   ros2 run motor_control_ros2 motor_control_node --ros-args --log-level warn
   ```

## ğŸ“š æ€§èƒ½æŒ‡æ ‡

- **æ§åˆ¶é¢‘ç‡**: 500 Hz âœ…
- **å‘å¸ƒé¢‘ç‡**: 100 Hz âœ…
- **ç›‘æ§åˆ·æ–°**: 100 Hz âœ…
- **å¿ƒè·³è¶…æ—¶**: 500 ms
- **CAN æ³¢ç‰¹ç‡**: 921600 bps
- **ä¸²å£æ³¢ç‰¹ç‡**: 4000000 bps

## ğŸ”„ ä¸‹ä¸€æ­¥å¼€å‘

- [ ] YAML é…ç½®è§£æ
- [ ] ç”µæœºé©±åŠ¨ä¼˜åŒ–
- [ ] å®Œæ•´åŠŸèƒ½æµ‹è¯•
- [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•
- [ ] å¤šç”µæœºååŒæµ‹è¯•

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Ctrl+C é€€å‡º**: ä¸¤ä¸ªèŠ‚ç‚¹éƒ½èƒ½æ­£ç¡®å“åº” Ctrl+C
2. **ç»ˆç«¯å¤§å°**: ç›‘æ§èŠ‚ç‚¹éœ€è¦è‡³å°‘ 80 åˆ—å®½çš„ç»ˆç«¯
3. **é¢œè‰²æ”¯æŒ**: ç¡®ä¿ç»ˆç«¯æ”¯æŒ ANSI é¢œè‰²ä»£ç 
4. **å¿ƒè·³æ£€æµ‹**: ç”µæœºæ–­å¼€å 500ms å†…ä¼šè‡ªåŠ¨æ ‡è®°ä¸ºç¦»çº¿

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æ›´æ–°æ—¶é—´**: 2026-01-15  
**ç»´æŠ¤è€…**: Motor Control Team
